<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=7.1.1"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Hackerose">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hackerose">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hackerose">





  
  
  <link rel="canonical" href="http://yoursite.com/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Hackerose</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hackerose</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/20/20190820-JS模块的编译与在Python中的调用/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/20/20190820-JS模块的编译与在Python中的调用/" class="post-title-link" itemprop="url">JS模块的编译与在Python中的调用</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-20 16:43:54 / Modified: 18:16:56" itemprop="dateCreated datePublished" datetime="2019-08-20T16:43:54+08:00">2019-08-20</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前两天遇到这样一个需求。</p>
<p>我们需要将新版本的 <a href="https://www.elastic.co/downloads/past-releases/kibana-6-7-2" target="_blank" rel="noopener">Kibana</a> 源码中，关于 <code>Kibana Query Language</code>（简称 <a href="https://www.elastic.co/guide/en/kibana/master/kuery-query.html" target="_blank" rel="noopener">kuery</a>）转换为 Elasticsearch 的 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_blank" rel="noopener">Query DSL</a> 的模块，直接用到我们 Python 程序的代码块中，以支持一些用户使用 <code>kuery</code> 语法查询创建的定时查询任务。</p>
<p>这里简单记录一下实现这个需求的过程，以及遇到的一些问题。</p>
<h4 id="事前准备"><a href="#事前准备" class="headerlink" title="事前准备"></a>事前准备</h4><p>实际上抽象化上面描述的需求，就是需要将一个 JS 模块进行打包（最好成为一个独立的 <code>.js</code> 文件），然后通过 Python 调用执行这个 JS 文件所提供的方法，获取处理结果进行后续使用。所以总共要做的事情就分为了两大块</p>
<ol>
<li>JS 模块的打包</li>
<li>Python 调用 JS 脚本</li>
</ol>
<h4 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h4><p>上述的第二个点不难，上网搜索就能找到名为 <a href="https://github.com/doloopwhile/PyExecJS" target="_blank" rel="noopener">PyExecJS</a> 库，虽然标明了已经 <code>End of Life</code> 了，但是就目前的使用情况来看，是够用的了。其使用方法，这里也不在累述（当然，我自己在使用过程中，关于编码方面的一个小坑，我也会在<code>其他文章</code>中简单记录）。</p>
<p>那么回头看第一个点，<code>JS 模块的打包</code>，就是本文主要描述的内容。</p>
<h4 id="JS-模块打包"><a href="#JS-模块打包" class="headerlink" title="JS 模块打包"></a>JS 模块打包</h4><p>其实本人的 JS 语言不算精通，目前也只是在公司、个人项目中使用到了 <code>jQuery</code>、<code>vueJS</code>、<code>ReactJS</code> 这几个库。提到打包用的工具，首先想到的是 <code>webpack</code>。</p>
<p><code>webpack</code> 简单点说，就是一个帮助 JS 开发者在使用 JS 语言进行 <strong>网页</strong> 应用开发时，经常用到的一个打包工具，这里为什么强调 <strong>网页</strong> 应用，是因为根据我自己的理解，webpack 在打包过程中，会向代码添加一些包含浏览器所提供的 API 的内容，与我们当前的场景是不同、甚至说是 <strong>相违背</strong> 的（因为，我们需要在 node 环境下去运行代码，而非浏览器上）。</p>
<p>经过一步步的踩坑与实践，我最终使用了 <a href="https://rollupjs.org/guide/en/" target="_blank" rel="noopener">rollup.js</a> 打包工具。同时，由于 Kibana 源码中使用了 CommonJS 以及 ES6 语法，所以我们需要一个语法转换插件，常用的就是 <code>babel</code>。</p>
<p>另一方面，我们需要对 Kibana 的 <code>Kuery</code> 模块再封装一层方法，方便 Python 代码进行调用，所以我新增了一个 <code>index.js</code> 入口文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 将 Kibana Query Language 的查询转换为 ES DSL</span><br><span class="line">import * as ast from &apos;./kuery/ast&apos;</span><br><span class="line">import &#123; nodeTypes &#125; from &apos;./kuery/node_types/index&apos;</span><br><span class="line"></span><br><span class="line">export function toElasticsearchQuery (val) &#123;</span><br><span class="line">  var res = &#123;&#125;</span><br><span class="line">  res = ast.toElasticsearchQuery(ast.fromKueryExpression(val, &#123;&#125;))</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个入口文件，就暴露了名为 <code>toElasticsearchQuery</code> 的函数。有了工具，定义好了入口文件，那么我们可以编辑 <code>rollup.config.js</code> 配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import babel from &apos;rollup-plugin-babel&apos;;</span><br><span class="line">import commonjs from &apos;rollup-plugin-commonjs&apos;;</span><br><span class="line">import resolve from &apos;rollup-plugin-node-resolve&apos;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  input: &apos;src/index.js&apos;,</span><br><span class="line">  output: [</span><br><span class="line">    &#123;</span><br><span class="line">      file: &apos;dist/tool.js&apos;,</span><br><span class="line">      format: &apos;cjs&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  plugins: [</span><br><span class="line">    resolve(),</span><br><span class="line">    commonjs(),</span><br><span class="line">    babel(&#123;</span><br><span class="line">      exclude: &apos;node_modules/**&apos;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>而代码的目录结构则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── dist</span><br><span class="line">│   └── tool.js    &lt;-- 打包后的 JS 脚本</span><br><span class="line">├── node_modules</span><br><span class="line">├── package-lock.json</span><br><span class="line">├── package.json</span><br><span class="line">├── rollup.config.js</span><br><span class="line">├── src</span><br><span class="line">│   ├── filters    &lt;-- 来自 kibana 源码</span><br><span class="line">│   ├── index.js   &lt;-- 新增的入口文件</span><br><span class="line">│   └── kuery      &lt;-- 来自 kibana 源码</span><br></pre></td></tr></table></figure>
<p>完成上述工作后，使用 <code>rollup -c</code> 进行编译打包，出现了如下报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[!] Error: &apos;get&apos; is not exported by node_modules/lodash/object.js</span><br><span class="line">https://rollupjs.org/guide/en/#error-name-is-not-exported-by-module</span><br><span class="line">src/kuery/functions/exists.js (20:9)</span><br><span class="line">18:  */</span><br><span class="line">19:</span><br><span class="line">20: import &#123; get &#125; from &apos;lodash/object&apos;;</span><br><span class="line">             ^</span><br><span class="line">21: import * as literal from &apos;../node_types/literal&apos;;</span><br><span class="line">Error: &apos;get&apos; is not exported by node_modules/lodash/object.js</span><br></pre></td></tr></table></figure>
<p>通过参考此 <a href="https://github.com/rollup/rollup-plugin-commonjs/issues/266" target="_blank" rel="noopener">issue</a>，得知是 CommonJS 在引入模块时的一些问题。修改 <code>rollup.config.js</code> 配置如下（如果可以的话，我会再深入研究下这个问题，可以参考 <a href="https://adrianmejia.com/getting-started-with-node-js-modules-require-exports-imports-npm-and-beyond/" target="_blank" rel="noopener">此文章</a>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import babel from &apos;rollup-plugin-babel&apos;;</span><br><span class="line">import commonjs from &apos;rollup-plugin-commonjs&apos;;</span><br><span class="line">import resolve from &apos;rollup-plugin-node-resolve&apos;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  input: &apos;src/index.js&apos;,</span><br><span class="line">  output: [</span><br><span class="line">    &#123;</span><br><span class="line">      file: &apos;dist/tool.js&apos;,</span><br><span class="line">      format: &apos;cjs&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  plugins: [</span><br><span class="line">    resolve(),</span><br><span class="line">    commonjs(&#123;</span><br><span class="line">      namedExports: &#123;</span><br><span class="line">        &apos;node_modules/lodash/object.js&apos;: [ &apos;get&apos; ],     &lt;-- 相当于告诉 rollup.js，get 在 lodash 的 object.js 被 export 出来</span><br><span class="line">        &apos;src/kuery/ast/kuery.js&apos;: [ &apos;parse&apos; ],          &lt;-- kuery 的模块也遇到类似问题</span><br><span class="line">        &apos;src/kuery/ast/legacy_kuery.js&apos;: [ &apos;parse&apos; ]    &lt;-- kuery 的模块也遇到类似问题</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">    commonjs(),</span><br><span class="line">    babel(&#123;</span><br><span class="line">      exclude: &apos;node_modules/**&apos;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>编译之后我们得到 <code>tool.js</code>，那么测试下 <code>tool.js</code> 是否可以正常被调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; var ttt = require(&quot;./dist/tool&quot;)</span><br><span class="line">undefined</span><br><span class="line"></span><br><span class="line">&gt; ttt</span><br><span class="line">&#123; toElasticsearchQuery: [Function: toElasticsearchQuery$d] &#125;</span><br><span class="line"></span><br><span class="line">&gt; JSON.stringify(ttt.toElasticsearchQuery(&apos;message: a or raw: b&apos;))</span><br><span class="line">&apos;&#123;&quot;bool&quot;:&#123;&quot;should&quot;:[&#123;&quot;bool&quot;:&#123;&quot;should&quot;:[&#123;&quot;match&quot;:&#123;&quot;message&quot;:&quot;a&quot;&#125;&#125;],&quot;minimum_should_match&quot;:1&#125;&#125;,&#123;&quot;bool&quot;:&#123;&quot;should&quot;:[&#123;&quot;match&quot;:&#123;&quot;raw&quot;:&quot;b&quot;&#125;&#125;],&quot;minimum_should_match&quot;:1&#125;&#125;],&quot;minimum_should_match&quot;:1&#125;&#125;&apos;</span><br></pre></td></tr></table></figure>
<h4 id="Python-模块的引入"><a href="#Python-模块的引入" class="headerlink" title="Python 模块的引入"></a>Python 模块的引入</h4><p>这里通过 Python 代码引入，就比较简单了，封装的代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import execjs</span><br><span class="line">import json</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class KueryConvertor(object):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用于进行 kuery 语法到 DSL 语法的转换，仅单向</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def __init__(self):</span><br><span class="line">        # 引入 js 模块，给予 ctx 以便之后执行</span><br><span class="line">        self.js_func_name = &apos;toElasticsearchQuery&apos;</span><br><span class="line">        self.ctx = execjs.compile(&quot;&quot;&quot;</span><br><span class="line">              tool = require(&apos;&#123;0&#125;/dist/tool&apos;)</span><br><span class="line">              function toElasticsearchQuery (_kuery) &#123;&#123;</span><br><span class="line">                return tool.&#123;1&#125;(_kuery)</span><br><span class="line">              &#125;&#125;</span><br><span class="line">            &quot;&quot;&quot;.format(os.path.dirname(os.path.realpath(__file__)))</span><br><span class="line"></span><br><span class="line">    def to_elasticsearch_query(self, _kuery):</span><br><span class="line">        return self.ctx.call(&apos;toElasticsearchQuery, _kuery)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/09/20190709-Python中的eval函数/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/09/20190709-Python中的eval函数/" class="post-title-link" itemprop="url">Python中的eval函数</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-09 15:46:59 / Modified: 16:16:01" itemprop="dateCreated datePublished" datetime="2019-07-09T15:46:59+08:00">2019-07-09</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天工作中，在处理一个配置文件扫描信息的任务时，同事给了一个使用 Python <code>eval()</code> 函数的较为便捷的方法，在此记录。</p>
<p>当时需要做的事情就是，扫描线上的一些配置文件，将文件中类似下面这种样式的信息提取出来，并获得其中的第一个 host 的 IP、端口信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host =&gt; [&quot;10.0.0.1:8888&quot;, &quot;10.1.1.1:8888&quot;]</span><br></pre></td></tr></table></figure>
<p>说着 Python 用了这么久了，但其实思维还是没从一个烧锅炉的转变过来（本科属于学校的’自动化’，其实主修强电方向，对口的就是去火电厂烧锅炉哈哈）。</p>
<p>所以拿到这个问题，第一个反映就是一股脑的逐行扫描、正则匹配、切分匹配到的字段。那么问题来了，线上的配置多种多样，有的可不是那么标准。例如 <code>[&quot;10.0.0.1:8888&quot;, &quot;10.1.1.1:8888&quot;]</code> 这部分，很多都是用成了单引号，这就不得不增加了正则的复杂程度。</p>
<p>由于旧的代码比较丑陋，而且不 <code>Pythonic</code>，所以就不贴上来丢人现眼了，直接切入正题，也就是同事给的使用 <code>eval()</code> 函数的思路。</p>
<h4 id="使用-eval-函数"><a href="#使用-eval-函数" class="headerlink" title="使用 eval 函数"></a>使用 eval 函数</h4><p>很早其实接触编程，就看到过 <code>eval()</code> 函数的介绍。在 Python 中简单来说，它会 <strong><em>执行传入的代码</em></strong>。</p>
<p>在我上面提到的任务中，<code>eval()</code> 函数可以极大的简化数据处理流程。</p>
<p>比如在第一步预处理过程中，我们已经获取到了正则匹配到的 <code>[&quot;10.0.0.1:8888&quot;, &quot;10.1.1.1:8888&quot;]</code> 这个字符串，那我们可以直接使用 <code>eval(&#39;[&quot;10.0.0.1:8888&quot;, &quot;10.1.1.1:8888&quot;]&#39;)</code>，将这个字符串转换成 Python 的 list 对象，便于我们后续的处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [15]: type(eval(&apos;[&quot;10.0.0.1:8888&quot;, &quot;10.1.1.1:8888&quot;]&apos;))</span><br><span class="line">Out[15]: list</span><br></pre></td></tr></table></figure>
<p>但是值得注意的是，这个函数同时也 <strong><em>非常的危险</em></strong>（很多书籍中都有提到），因为一旦使用不当，被人利用，会有不可预计的后果。例如下面这段输入，就会被用来移除系统中的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [12]: eval(&quot;__import__(&apos;os&apos;).remove(&apos;file&apos;)&quot;)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OSError                                   Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input-12-c9b8da757f01&gt; in &lt;module&gt;()</span><br><span class="line">----&gt; 1 eval(&quot;__import__(&apos;os&apos;).remove(&apos;file&apos;)&quot;)</span><br><span class="line"></span><br><span class="line">&lt;string&gt; in &lt;module&gt;()</span><br><span class="line"></span><br><span class="line">OSError: [Errno 2] No such file or directory: &apos;file&apos;</span><br></pre></td></tr></table></figure>
<p>还好 <code>file</code> 文件是不存在的，不然就给跪了。更多的，<code>eval()</code> 是用于 Python 的交互式程序中，获取一些用户的指令输入，同时，一定要考虑到安全性方面的问题。</p>
<h4 id="使用-json-模块"><a href="#使用-json-模块" class="headerlink" title="使用 json 模块"></a>使用 json 模块</h4><p>进一步的，由于清楚地知道 <code>eval()</code> 函数存在的危险性，不希望它出现在我们的代码中的话，怎么办呢。这时我想到了 <code>json.loads()</code> 函数，较前者来说，更为安全，他只是对我需要的字符串进行解析（当然，是要符合 json 标准的格式）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [19]: x = json.loads(&apos;[&quot;10.0.0.1:8888&quot;, &quot;10.1.1.1:8888&quot;]&apos;)</span><br><span class="line"></span><br><span class="line">In [20]: x</span><br><span class="line">Out[20]: [u&apos;10.0.0.1:8888&apos;, u&apos;10.1.1.1:8888&apos;]</span><br></pre></td></tr></table></figure>
<p>总体来说，更加推荐使用 <code>json.loads()</code>，至少心理上感觉更加安全 :p</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/20190620-Javascript中空对象的判断/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/20/20190620-Javascript中空对象的判断/" class="post-title-link" itemprop="url">Javascript中空对象的判断</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-20 16:59:20" itemprop="dateCreated datePublished" datetime="2019-06-20T16:59:20+08:00">2019-06-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-27 09:39:20" itemprop="dateModified" datetime="2019-06-27T09:39:20+08:00">2019-06-27</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天在用 vuejs 时，当判断后端 API 返回为空的时候，发现一个新手（像我一样的新手，只会面向谷歌的编程）可能会遇到的问题，那就是如何判断一个 Object 为空。</p>
<p>很方便的，我们可以在浏览器的 console 中进行测试，如果以 <code>===</code> 运算符去进行比较，得到的结果不是我们想要的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#125; === &#123;&#125;</span><br><span class="line">false</span><br></pre></td></tr></table></figure>
<p>但是这种比较方式在 python 中是成立的（当然 python 中是用 <code>==</code>）。我们在这里先分析为什么在 Javascript 中不能这么比较，然后简单思考下为什么在 Python 中则是可以的。</p>
<h4 id="Javascript-中空对象的判断"><a href="#Javascript-中空对象的判断" class="headerlink" title="Javascript 中空对象的判断"></a>Javascript 中空对象的判断</h4><p>很简单，一句话概括为什么上面的判断方式不行：Javascript 将对象赋值给一个变量的时候，这个变量其实是这个对象的引用。</p>
<p>通俗一点讲，这个变量表明的是我们的对象储存在内存的哪个地址。对于两个不同的对象，储存的地址当然不同，那么结果就顺理成章的为 <code>false</code>.</p>
<p>这种行为是与 C 或者 C++ 类似的，所以在 Javascript 中 <strong>切忌对 Object 进行比较</strong>，很容易让你的代码无法达到期望的效果。</p>
<h4 id="如何判断空对象"><a href="#如何判断空对象" class="headerlink" title="如何判断空对象"></a>如何判断空对象</h4><p>网上能够找到<a href="https://stackoverflow.com/questions/679915/how-do-i-test-for-an-empty-javascript-object" target="_blank" rel="noopener">很多方式</a>，这里摘选比较便捷的一种。</p>
<p>因为代码中引入了 <a href="https://lodash.com/" target="_blank" rel="noopener">lodash库</a>，直接使用库中自带的方法即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.isEmpty(yourObject)</span><br></pre></td></tr></table></figure>
<h4 id="为何-Python-就可以"><a href="#为何-Python-就可以" class="headerlink" title="为何 Python 就可以"></a>为何 Python 就可以</h4><p>Python 运行如下代码的结果，返回是 <code>True</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [1]: &#123;&#125; == &#123;&#125;</span><br><span class="line">Out[1]: True</span><br><span class="line">In [2]: a = &#123;&#125;</span><br><span class="line">In [3]: b = &#123;&#125;</span><br><span class="line">In [4]: a == b</span><br><span class="line">Out[4]: True</span><br><span class="line">In [5]: c = &#123;&apos;key&apos;: 1&#125;</span><br><span class="line">In [6]: d = &#123;&apos;key&apos;: 1&#125;</span><br><span class="line">In [7]: c == d</span><br><span class="line">Out[7]: True</span><br></pre></td></tr></table></figure>
<p>我们用的是 Python2，那么参考<a href="https://docs.python.org/2/reference/datamodel.html#object.__eq__" target="_blank" rel="noopener">对应文档</a>，如果我们使用 <code>==</code> 比较两个字典，那么将会调用 <code>dict 类</code> 的 <code>__eq__</code> 方法，这个方法能够自由的去定义比较 Python 对象时候的行为。</p>
<p>但是，我在文档中没有找到是如何定义这种比较方式的下文了。求助命令行，结果也是令人失望的（Python 的文档果然还是不行啊）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [20]: help(c.__eq__)</span><br><span class="line"></span><br><span class="line">Help on method-wrapper object:</span><br><span class="line"></span><br><span class="line">__eq__ = class method-wrapper(object)</span><br><span class="line"> |  Methods defined here:</span><br><span class="line"> |</span><br><span class="line"> |  __call__(...)</span><br><span class="line"> |      x.__call__(...) &lt;==&gt; x(...)</span><br><span class="line"> |</span><br><span class="line"> |  __cmp__(...)</span><br><span class="line"> |      x.__cmp__(y) &lt;==&gt; cmp(x,y)</span><br><span class="line"> |</span><br><span class="line"> |  __getattribute__(...)</span><br><span class="line"> |      x.__getattribute__(&apos;name&apos;) &lt;==&gt; x.name</span><br><span class="line"> |</span><br><span class="line"> |  __hash__(...)</span><br><span class="line"> |      x.__hash__() &lt;==&gt; hash(x)</span><br><span class="line"> |</span><br><span class="line"> |  __repr__(...)</span><br><span class="line"> |      x.__repr__() &lt;==&gt; repr(x)</span><br><span class="line"> |</span><br><span class="line"> |  ----------------------------------------------------------------------</span><br><span class="line"> |  Data descriptors defined here:</span><br><span class="line"> |</span><br><span class="line"> |  __objclass__</span><br><span class="line"> |</span><br><span class="line"> |  __self__</span><br></pre></td></tr></table></figure>
<p>但是我们从结果上可以推断，Python 在比较两个 dict 的时候，<strong><strong>eq</strong> 方法是会逐一比较其所包含的所有 key 所对应的值的</strong>。等哪天有空再看 Python 源码的时候，仔细研究这个 <code>__eq__</code> 魔方方法在 dict 中是如何实现的（给自己挖坑）。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/03/20190603-用Python去解释何为倒排索引/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/03/20190603-用Python去解释何为倒排索引/" class="post-title-link" itemprop="url">用Python去解释何为倒排索引</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-03 14:32:09" itemprop="dateCreated datePublished" datetime="2019-06-03T14:32:09+08:00">2019-06-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-09 15:45:42" itemprop="dateModified" datetime="2019-07-09T15:45:42+08:00">2019-07-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先，本文基于参考<a href="https://medium.com/@fro_g/writing-a-simple-inverted-index-in-python-3c8bcb52169a" target="_blank" rel="noopener">此博文</a>。</p>
<p>因为最近想到既然自己在做 ELK 相关的内容，那么就要了解下 ES 的本质，加上自己最熟悉的语言就是 Python，所以就顺手上网搜了下前人总结的一些相关经验。本文也是对这些内容的二次消化，加上一些自己对于某些细节部分的解读。当然本文的理解可能也只停留在一个浅显的层面，没有深入的研究源码，但是这也是为之后的学习开一个头。</p>
<h4 id="理解倒排"><a href="#理解倒排" class="headerlink" title="理解倒排"></a>理解倒排</h4><p>倒排索引，其实是定义的一种查询方式，直接通过中文理解很容易产生歧义。但是看到其英文 – <code>Inverted Index</code>，就能理解这个 <code>倒</code> 究竟是什么意思了。</p>
<p>这里的<code>倒</code>，并不是我们的数据在储存顺序上的颠倒，更贴切的说，是一种查询逻辑上的颠倒。</p>
<p>通俗来讲，我们原有如果是通过 <strong>*索引/ID**</strong> A 找到其对应的数据 B，那么就可以说这是一种 <strong>正排索引</strong> 逻辑；反之，如果是通过数据 B，找到其 <strong>*索引/ID**</strong> A (当然，还有其他一些信息)，那么就可以说是一种 <strong>倒排索引</strong> 逻辑。</p>
<p>那么倒排索引，为什么能够被广泛的应用在全文检索的场景中，从上面的理解中，答案也就顺理成章的浮现出来了。</p>
<p>如果想想一下用 <strong>正排索引</strong> 的逻辑，去做一个文本的搜索，我们要怎么查？因为我们不知道数据 B 中有没有要查的文本，只能每条记录逐一检查，然后返回符合条件记录的相关信息，效率想一想就很低。</p>
<p>如果遵循 <strong>倒排索引</strong> 的逻辑，那么我们相当于知道了哪些 <strong>*索引/ID**</strong> 对应的记录包含了需要搜索的文本内容，从感觉上 (是的，暂时是从感觉上)，效率就比较高。当然这种高效，是在全文检索的这一个使用场景下，因为避开使用场景的讨论，都是不实际的。</p>
<blockquote>
<p>PS: 这里稍微回头想一下，为什么 ES 中做分词、不做分词、用不同的分词器分词，搜索出来的文档结果集不一样呢？那是因为前面所说的各种情况，所生成的倒排索引不同，那么所得到的 B to A 的结果就各不相同了。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/30/20190530-celery使用踩坑记录/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/30/20190530-celery使用踩坑记录/" class="post-title-link" itemprop="url">celery使用踩坑记录</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-30 14:47:06" itemprop="dateCreated datePublished" datetime="2019-05-30T14:47:06+08:00">2019-05-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-27 09:39:15" itemprop="dateModified" datetime="2019-06-27T09:39:15+08:00">2019-06-27</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>线上调用接口，执行一些异步任务时，celery 的任务始终没有被触发，下面把排查过程以及之后对于此问题的一个理解进行一下总结</p>
</blockquote>
<h4 id="修复过程"><a href="#修复过程" class="headerlink" title="修复过程"></a>修复过程</h4><p>其实很简单，异步任务接口被触发时，会执行一个 <code>deploy()</code> 方法，让 celery 去执行一些 ansible 任务，但是看 celery 的日志始终没有触发任务。</p>
<p>而其它的异步任务，都是能够正常执行的，所以排除设置上或者应用层面的一些错误。</p>
<p>既然是有问题，那就与执行正常的代码对比一下，发现有问题的方法内触发 celery task 时，调用的 <code>apply_async()</code>，与其它正常执行的调用少了 <code>serializer=&#39;json&#39;</code> 参数。</p>
<p>加上这个参数后，就能正常执行了。</p>
<h4 id="原因探究"><a href="#原因探究" class="headerlink" title="原因探究"></a>原因探究</h4><p>虽然解决了问题，但是还是要看下为什么这里要加上 <code>serializer=&#39;json&#39;</code> 这个参数。</p>
<p>首先，目前我们使用的 celery 版本是 <code>3.1.24</code>，查询<a href="http://docs.celeryproject.org/en/3.1/userguide/calling.html#calling-serializers" target="_blank" rel="noopener">相关文档</a>，很容易就能找到如下描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Data transferred between clients and workers needs to be serialized, so every message in Celery has a content_type header that describes the serialization method used to encode it.</span><br><span class="line"></span><br><span class="line">The default serializer is pickle, but you can change this using the CELERY_TASK_SERIALIZER setting, or for each individual task, or even per message.</span><br><span class="line"></span><br><span class="line">There’s built-in support for pickle, JSON, YAML and msgpack, and you can also add your own custom serializers by registering them into the Kombu serializer registry (see ref:kombu:guide-serialization).</span><br></pre></td></tr></table></figure>
<p>找遍代码，没有全局的 <strong>CELERY_TASK_SERIALIZER</strong> 设定，所以每一个 task 就需要去设定 <code>serializer</code> 了，不然会默认使用 <code>pickle</code>.</p>
<p>但是，为什么默认 pickle 不行呢？文档中指出，<code>pickle</code> 是一个不安全的持久化方案，且 celery 可以通过 <strong>CELERY_ACCEPT_CONTENT</strong> 这个变量去作为白名单，只允许白名单中的持久化方案被用作 worker 和 client 之间的通信。</p>
<p>所以回头看配置文件，其中包含了这个白名单的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CELERY_ACCEPT_CONTENT = [&apos;json&apos;, ]</span><br></pre></td></tr></table></figure>
<p>所以一开始是出于安全考虑，仅可以支持 json 持久化方式去传递数据，在方法中未指定 <code>serializer</code> 的情况下，celery 库就自动终止了 client 发起的任务，导致后续的任务没有被执行。</p>
<h4 id="总结回顾"><a href="#总结回顾" class="headerlink" title="总结回顾"></a>总结回顾</h4><p>为什么使用 <code>pickle</code> 的持久化方式会存在安全隐患？这个又是后续的一个问题。</p>
<p>根据官方文档，提供了一个分析 <code>pickle</code> 存在的隐患的<a href="https://blog.nelhage.com/2011/03/exploiting-pickle/" target="_blank" rel="noopener">博客</a>。</p>
<p>值得注意的是这一段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pickle allows arbitrary objects to declare how they should be pickled by defining a __reduce__ method, which should return either a string or a tuple describing how to reconstruct this object on unpacking.</span><br></pre></td></tr></table></figure>
<p>简单来说，利用 pickle 库的特性，在客户端持久化数据前，定义一个改写过 <code>__reduce__</code> 方法的类，在服务端接收到这个数据时，会调用这个方法，很可能被被恶意代码启动一个危险的进程，导致服务器被黑。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/17/20190517-vim中的正则替换/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/17/20190517-vim中的正则替换/" class="post-title-link" itemprop="url">vim中的正则替换</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-17 14:33:44 / Modified: 17:46:59" itemprop="dateCreated datePublished" datetime="2019-05-17T14:33:44+08:00">2019-05-17</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="踩坑实录"><a href="#踩坑实录" class="headerlink" title="踩坑实录"></a>踩坑实录</h3><p>其实说是踩坑，其本质上是对于 vim 的不熟悉。</p>
<p>起因是在于相对一个 SQL 文件内容进行批量更改，至于更改的原因，是导出了线上的数据，希望导入到测试数据库时，json 类型的字段发生了报错，网上也有<a href="https://stackoverflow.com/questions/38078119/mysql-5-7-12-import-cannot-create-a-json-value-from-a-string-with-character-set" target="_blank" rel="noopener">对应解答</a>，具体的报错分析看在之后专门写一篇分析分析</p>
<p>根据网上给出的报错解决办法，我需要对 SQL 语句进行处理。</p>
<p>将</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO json_table (json_column) VALUES (X&apos;7B22666F6F223A2022626172227D&apos;);</span><br></pre></td></tr></table></figure>
<p>替换为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO json_table (json_column) VALUES (CONVERT(X&apos;7B22666F6F223A2022626172227D&apos; using utf8mb4));</span><br></pre></td></tr></table></figure>
<p>最方便的其实就想到了用 vim 中自带的正则替换功能。于是直接写了如下替换语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%s/X&apos;(.*)&apos;/CONVERT\(X&apos;\1&apos; USING utf8mb4\)/g</span><br></pre></td></tr></table></figure>
<p>但是回车一敲，就直接报<code>Pattern not found: X&#39;(.*)&#39;</code>的错误，看了半天，我的<code>()</code>是为了用来捕捉匹配的内容的啊。</p>
<p>百思不得姐，最终上网看<a href="https://vim.fandom.com/wiki/Search_and_replace" target="_blank" rel="noopener">相关的文档</a>，直接定位到了这一句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+, ?, |, &amp;, &#123;, (, and ) must be escaped to use their special function.</span><br></pre></td></tr></table></figure>
<p>原来，vim 中的 sed，在使用这些正则表达式的特殊符号时，是需要转义才能行使其在正则表达式中的特殊行为的，例如捕获、OR 表达的等等功能。</p>
<p>顺势改一下指令为如下，完美替换。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%s/X&apos;\(.*\)&apos;/CONVERT(X&apos;\1&apos;) USING utf8mb4)/g</span><br></pre></td></tr></table></figure>
<p>记录完毕，继续搬砖去。</p>
<h3 id="vim-中的非贪婪匹配"><a href="#vim-中的非贪婪匹配" class="headerlink" title="vim 中的非贪婪匹配"></a>vim 中的非贪婪匹配</h3><p>做事做着做着，发现一个问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%s/X&apos;(.*)&apos;/CONVERT\(X&apos;\1&apos; USING utf8mb4\)/g</span><br></pre></td></tr></table></figure>
<p>这个正则表达式是贪婪匹配，之前歪打正着没出问题，但是之后又有几个 SQL 要修改就暴露问题了。</p>
<p>然而，vim 中的非贪婪匹配并不是在其后直接加上 <code>\?</code> 就行了的(记得吗?要转义哦)</p>
<p>上网搜了一下，vim 中非贪婪匹配，用 <code>\{-}</code> 替换 <code>*</code> 即可，则之前的替换语句应该这样写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%s/X&apos;\(.\&#123;-&#125;\)&apos;/CONVERT(X&apos;\1&apos; USING utf8mb4)/g</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/20190428-用Python来描述一些基本算法--排序篇/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/28/20190428-用Python来描述一些基本算法--排序篇/" class="post-title-link" itemprop="url">用Python来描述一些基本算法--排序篇</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-28 18:17:58" itemprop="dateCreated datePublished" datetime="2019-04-28T18:17:58+08:00">2019-04-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-05-17 14:53:05" itemprop="dateModified" datetime="2019-05-17T14:53:05+08:00">2019-05-17</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="初衷"><a href="#初衷" class="headerlink" title="初衷"></a>初衷</h3><p>本身不是学计算机出身，所以说一些基本的概念还是比较薄弱的。很多次被问到一些基础的算法问题，其实脑海中都有印象自己看过，但是有时候就是想不起来。</p>
<p>用的少不是借口(虽然在开发过程中确实用的少)，现在看来，这些基础的算法概念，是对一个人逻辑思维的展现。其实思考这些算法的实现过程，也是一个“重复造轮子的过程”，但是，你写出来了，就是一个能够“造轮子的人”。</p>
<h3 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h3><p>其实这个是读书时期接触到的可谓是第一个算法，但是有时候知道概念，嗯，很简单，提笔写或者拿键盘敲起来，就下不了手了。这里，现根据印象，写一下这个方法(写的代码比较难看哈哈)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">def bsort(target=None):</span><br><span class="line">    if not target:</span><br><span class="line">        target = range(100)</span><br><span class="line">        random.shuffle(target)</span><br><span class="line">    print &apos;origin data: &#123;&#125;&apos;.format(target)</span><br><span class="line">    # 用于原始结果</span><br><span class="line">    res = copy.deepcopy(target)</span><br><span class="line">    counter = len(target)</span><br><span class="line">    while counter &gt; 0:</span><br><span class="line">        for idx, val in enumerate(target):</span><br><span class="line">            if idx != len(target) - 1 and val &gt; target[idx + 1]:</span><br><span class="line">                # 冒个泡，交换了的话，去到下一层循环时，其实取的就是新的值了</span><br><span class="line">                target[idx] = res[idx +1]</span><br><span class="line">                target[idx + 1] = res[idx]</span><br><span class="line">                res = copy.deepcopy(target)</span><br><span class="line">        counter -= 1</span><br><span class="line">    print &apos;sorted data: &#123;&#125;&apos;.format(target)</span><br></pre></td></tr></table></figure>
<p>写完后，google 一查，上面这东西有点在扯淡的感觉。</p>
<p>这个 counter 是什么鬼，为什么 couter 为 0 就结束排序呢，主要是，本人当时是跟着感觉走的。那么意思是对于任何长度的列表，我外层循环的次数一定要等于列表长度以保证排序完了？</p>
<p>而且，enumerate 使用不当！使用不当！使用不当！于是我这个菜鸟思考了一下，大概想了一下潜在问题，是否正确，会否看看源码。</p>
<blockquote>
<p>enumerate 本质上是个生成器，作用于的是一个可迭代对象，如果你在代码中修改了这个迭代对象，后果是难以预估的，你也不会得到想要的结果</p>
</blockquote>
<p>这些思想都很危险啊。</p>
<p>那么回头看看冒泡排序的概念，其关键语句如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对每一对相邻元素作同样的工作，从开始第一对到结尾的最后一对。这步做完后，最后的元素会是最大的数。</span><br><span class="line">这个工作，从第一个元素开始，到倒数第二个元素为结束的，这样，就能得到最大的元素在列表的结尾了。</span><br><span class="line">如上，然后循环的对子列表进行排序。</span><br></pre></td></tr></table></figure>
<p>好的，那么重新梳理下逻辑，那么改下我们的代码，就是如下的结果了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def bsort(target=None):</span><br><span class="line">    if not target:</span><br><span class="line">        target = range(10)</span><br><span class="line">    random.shuffle(target)</span><br><span class="line">    print &apos;origin data: &#123;&#125;&apos;.format(target)</span><br><span class="line">    # 记录现在处理到了哪个位置</span><br><span class="line">    current = len(target)</span><br><span class="line">    while current &gt; 0:</span><br><span class="line">        for idx in range(0, current - 1):</span><br><span class="line">               if target[idx] &gt; target[idx + 1]:</span><br><span class="line">                # 冒个泡，交换了的话，去到下一层循环时，其实取的就是新的值了</span><br><span class="line">                tmp = target[idx]</span><br><span class="line">                target[idx] = target[idx +1]</span><br><span class="line">                target[idx + 1] = tmp</span><br><span class="line">        current -= 1</span><br><span class="line">    print &apos;sorted data: &#123;&#125;&apos;.format(target)</span><br></pre></td></tr></table></figure>
<h3 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h3><p>快速排序的概念其实也是理解起来容易，但是对于我这种半路出家的人，想用代码的角度去阐释，还是要废点时间去思考的。</p>
<p>例如，这是我根据快排的概念自己撸的一段代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">def qsort(target):</span><br><span class="line">    # 先指定好起始游标</span><br><span class="line">    start = 0</span><br><span class="line">    end = len(target) - 1</span><br><span class="line">    # 首先设定好这个列表的基准值</span><br><span class="line">    base = target[start]</span><br><span class="line">    # 开始由两边向中间处理数据，start 我们暂时成为前序游标，end 则为后序游标</span><br><span class="line">    try:</span><br><span class="line">        while start &lt; end:</span><br><span class="line">            if target[end] &lt;= base:</span><br><span class="line">                # 如果后序游标指向的值小于基准值，那么我们把这个值放到前序游标指向的位置</span><br><span class="line">                target[start] = target[end]</span><br><span class="line">            else:</span><br><span class="line">                # 后序游标前移继续扫描</span><br><span class="line">                end -= 1</span><br><span class="line">            if target[start] &gt; base:</span><br><span class="line">                # 与上面对应，前序游标指向的值大于基准值，则移到后序游标的位置</span><br><span class="line">                target[end] = target[start]</span><br><span class="line">            else:</span><br><span class="line">                # 前序游标后移</span><br><span class="line">                start += 1</span><br><span class="line">        # 当前后游标相遇，则表示前后子列表都已经扫完，那么将 base 的值赋予当前游标指向的位置</span><br><span class="line">        target[start] = base</span><br><span class="line">        # 对两边的子列表递归</span><br><span class="line">        qsort(target[0:start])</span><br><span class="line">        qsort(target[start + 1:])</span><br><span class="line">    except IndexError:</span><br><span class="line">        print &apos;processing error, &#123;&#125;, start &#123;&#125;, end &#123;&#125;&apos;.format(target, start, end)</span><br></pre></td></tr></table></figure>
<p>这段代码可谓是千疮百孔，根本运行不成功是有原因的。首先就是因为并没有完全理解快排的概念，其次就是 python 的一些概念没有熟练掌握。</p>
<p>例如简单说下上述代码的问题：</p>
<ol>
<li>首先，强调过很多次的，递归需要有一个结束递归的判断，没有的话，那是相当的危险；</li>
<li>其次，根据快排的思路，从后序游标开始进行扫描时，并不是进行一次 if 判断就结束然后跳到前序游标扫描的逻辑的；正确的做法是从后序游标开始处理，不停的比较，直到与前序游标重合，或者找到了比基准值小的值，则停止搜索，并做后续处理的</li>
<li>然后，也就是最后调用递归的部分，采用了数组切片进行传参，但是，要强调的是，<strong>切片</strong>操作是返回一个全新的列表，意思就是其实我们递归的操作，修改的也是新的列表的内容，与我们的预期是不符的</li>
</ol>
<p>稍微总结一下之后，修改代码，得到一个最终的答案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">def qsort(target, start, end):</span><br><span class="line">    # 定义好停止递归的方式</span><br><span class="line">    if start &gt;= end:</span><br><span class="line">        return target</span><br><span class="line">    # 设定当前列表的基准值</span><br><span class="line">    base = target[start]</span><br><span class="line">    low = start</span><br><span class="line">    high = end</span><br><span class="line">    # 开始由两边向中间处理数据，start 我们暂时成为前序游标，end 则为后续游标</span><br><span class="line">    while start &lt; end:</span><br><span class="line">        while start &lt; end and target[end] &gt; base:</span><br><span class="line">            # 后续游标前移继续扫描</span><br><span class="line">            end -= 1</span><br><span class="line">        # 我们找到了一个后续游标，其指向的值小于基准值，那么我们把这个值放到前序游标指向的位置</span><br><span class="line">        target[start] = target[end]</span><br><span class="line">        while start &lt; end and target[start] &lt;= base:</span><br><span class="line">            # 前序游标后移</span><br><span class="line">            start += 1</span><br><span class="line">        # 与上面对应，前序游标指向的值大于基准值，则移到后续游标的位置</span><br><span class="line">        target[end] = target[start]</span><br><span class="line">    # 当前后游标相遇，则表示前后子列表都已经扫完，那么将 base 的值赋予当前游标指向的位置</span><br><span class="line">    target[start] = base</span><br><span class="line">    # 对两边的子列表递归</span><br><span class="line">    qsort(target, low, start - 1)</span><br><span class="line">    qsort(target, start + 1, high)</span><br><span class="line">    return target</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/20190428-Python字典的实用操作记录/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/28/20190428-Python字典的实用操作记录/" class="post-title-link" itemprop="url">Python的实用代码记录</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-28 15:01:51" itemprop="dateCreated datePublished" datetime="2019-04-28T15:01:51+08:00">2019-04-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-05-17 14:52:58" itemprop="dateModified" datetime="2019-05-17T14:52:58+08:00">2019-05-17</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="反转列表"><a href="#反转列表" class="headerlink" title="反转列表"></a>反转列表</h3><p>列表反转比较简单，列表原生方法 <code>reverse()</code> 既可以实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [1]: a = [1,2,3]</span><br><span class="line"></span><br><span class="line">In [2]: a.reverse()</span><br><span class="line"></span><br><span class="line">In [3]: a</span><br><span class="line">Out[3]: [3, 2, 1]</span><br></pre></td></tr></table></figure>
<p>如果你想表现得有种来去如风的感觉，而且是想直接反转列表并赋值，也可以这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 因为上面的 a 已经被 reverse 过了</span><br><span class="line">In [4]: a[::-1]</span><br><span class="line">Out[4]: [1, 2, 3]</span><br></pre></td></tr></table></figure>
<p><code>[::-1]</code>，以 <code>:</code> 分隔，三个部分分别表示开始的索引位置，结束的索引位置，以及步长，<code>[::-1]</code> 其实也是 <code>a[-1:-4:-1]</code> 的简写，当然，你可能事先不知道列表的长度，所以直接 <code>[::-1]</code> 是最简单的写法。</p>
<h3 id="合并字典"><a href="#合并字典" class="headerlink" title="合并字典"></a>合并字典</h3><p>不多说，先上代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def merge(source, target):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用于将两个字典进行合并</span><br><span class="line">    :param target: 希望被更新的字典</span><br><span class="line">    :param source: 包含新数据的字典</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # 将两个字典进行合并，同个字段，由 target 的值覆盖 source 的值，如果不存在，则新增</span><br><span class="line">    # 简化版本，参考网上递归</span><br><span class="line">    for k, v in source.iteritems():</span><br><span class="line">        if isinstance(v, dict):</span><br><span class="line">            node = target.setdefault(k, &#123;&#125;)</span><br><span class="line">            merge(v, node)</span><br><span class="line">        else:</span><br><span class="line">            target[k] = v</span><br><span class="line">    return target</span><br></pre></td></tr></table></figure>
<p>代码是很简单的迭代思路，值得注意的是，<code>setdefault()</code> 方法的使用。</p>
<p>其实之前本人是对这个方法的使用时有所误解的，只是简单的认为这个方法是当字典中<code>指定的某个 key 不存在时，则增加这个 key 并赋值</code>，但是其实，这个方法是<strong>有返回值</strong>的，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key 不存在，则设定这个 key 的值为 setdefault() 方法中第二个参数的值，并返回</span><br><span class="line">key 存在，则直接返回这个 key 的值，并且，不会用第二个参数的值去覆盖原有的值!!!</span><br></pre></td></tr></table></figure>
<p>所以，setdefault() 成为了这个 merge() 方法的核心。另外一点就是，我们获取的值，即 node，是本身 target 字典中对应”节点”的引用，所以修改 node 的内容，会直接改变 target 这个传入的字典。</p>
<h3 id="扁平化与反扁平化字典"><a href="#扁平化与反扁平化字典" class="headerlink" title="扁平化与反扁平化字典"></a>扁平化与反扁平化字典</h3><p>扁平化字典的需求，其实是在做开发的时候遇到的问题，就是希望把一个嵌套类型的字典，如 <code>{&#39;a&#39;: {&#39;b&#39;: {&#39;c&#39;: 1}}}</code>，转换成为如<code>{&#39;a.b.c&#39;: 1}</code>这种形式，其根本目的是希望能够让前端的程序，在列表中，更好的展现这个字典的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def function(data):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用于将复杂的结构转换为友好的字段名格式</span><br><span class="line">    :param data:</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    stack = [((), data)]</span><br><span class="line">    result = []</span><br><span class="line">    while stack:</span><br><span class="line">        field_name, current = stack.pop()</span><br><span class="line">        for k, v in current.iteritems():</span><br><span class="line">            if isinstance(v, dict):</span><br><span class="line">                stack.append((field_name + (k,), v))</span><br><span class="line">            else:</span><br><span class="line">                result.append(&#123;</span><br><span class="line">                    &quot;.&quot;.join((field_name + (k,))): v</span><br><span class="line">                &#125;)</span><br><span class="line">    return sorted(result, key=lambda t: t[0])</span><br></pre></td></tr></table></figure>
<p>代码整体的思路比较简单，首先设定一个限于函数内存的栈，用来缓存处理的信息，而推入栈中的内容，是一个元组，包含以下两个项：</p>
<ol>
<li>当前的字段列表，即能够表明，这个元组表示的是字典中的哪一个节点</li>
<li>该节点的内容，即表示，在这一层中，数据的内容是什么</li>
</ol>
<p>那么捋一捋之后就比较清楚整体的逻辑了，即从整个字典开始扫，如果发现下一层元素的值仍然是个字典，那么，将这个元素的 key 以及 value 放到 stack 中，等待 while 循环进行处理。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/20180711-查看Linux进程占用内存/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/07/11/20180711-查看Linux进程占用内存/" class="post-title-link" itemprop="url">查看Linux进程占用内存</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-11 11:04:27" itemprop="dateCreated datePublished" datetime="2018-07-11T11:04:27+08:00">2018-07-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-05-17 14:53:18" itemprop="dateModified" datetime="2019-05-17T14:53:18+08:00">2019-05-17</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>用了这么久 Linux，当有人问起一些基础的指令问题的时候，还是会愣一下。回头想想，现在老了，记性不好了，对于不常用的东西，还是找个地方把他存盘好一点。</p>
</blockquote>
<h3 id="方便快捷-PS"><a href="#方便快捷-PS" class="headerlink" title="方便快捷 - PS"></a>方便快捷 - PS</h3><p>查看内存使用，我们可能第一时间想到的是用 top，但是像我这种半吊子来说，top 在我脑海中始终是那个充满着一堆动态变化数据的表格。那些在界面中的各种复杂骚操作早已忘得一干二净。回过头来，其实 Linux 中最常用的指令 <code>ps</code>，就能够满足需求。</p>
<p>话不多说，先上指令:</p>
<p>  <code>ps -eo rss,pmem,pcpu,vsize,args</code></p>
<p>上面的指令就是对进程信息进行格式化输出，<code>-o</code>参数，加上后面的字段，指定了我们希望输出的信息。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rss: resident set size 的缩写，表示进程占用的内存大小，以 KB 为单位</span><br><span class="line">pmem: percentage of memory，表示内存占用百分比</span><br><span class="line">pcpu: percentage of cpu usage，表示 cpu 占用百分比</span><br><span class="line">vsize: 表示进程占用虚拟内存大小，以 KB 为单位</span><br><span class="line">args: 进程名，或者指令的名称</span><br></pre></td></tr></table></figure>
<p>上面这几个参数是我们最经常用到的，那么如果我们要使用其中某个数值字段进行排序，我们会用到<code>sort</code>指令</p>
<p>  <code>ps -eo rss,pmem,pcpu,vsize,args | sort -k 1 -r -n | less</code></p>
<p>上面<code>-k</code>参数表示的是我需要按照管道传入数据的第几列数据进行排序，另外两个参数不累述。</p>
<h3 id="清晰详细-TOP"><a href="#清晰详细-TOP" class="headerlink" title="清晰详细 - TOP"></a>清晰详细 - TOP</h3><p>top 的话本人用的比较少，下面简单的总结记录一下。</p>
<p>使用 top 查看进程的内存占用等信息，首先我们可以用 ps 指令找出进程的 pid</p>
<p>  <code>ps aux | awk &#39;/&lt;process_name&gt;/&#39;</code></p>
<blockquote>
<p>这里值得注意的是，其实 <code>ps aux</code> 输出的第 3、4 列，就已经分别表示了进程的 CPU 以及内存的占用率(百分比)，第 5、6 列，则是 VSZ、RSS，即虚拟内存占用大小（virtual memory size，和实际内存占用大小（resident set size）</p>
</blockquote>
<p>然后使用如下指令</p>
<p>  <code>top -p &lt;pid&gt;</code></p>
<blockquote>
<p>PS: 进入到 top 的交互界面时，按 <code>c</code> 键的话，可以看到完整的 command，此时如果再按 <code>shift + w</code> 的话，就能记住此配置，以便下次打开时直接显示完整的 command。</p>
</blockquote>
<h3 id="更进一步"><a href="#更进一步" class="headerlink" title="更进一步"></a>更进一步</h3><p>其实很多情况下，无论在服务器排查故障或者调查应用的性能问题时，不仅仅需要到进程的层面，而需要更深入的查看线程的资源使用情况。</p>
<p>那么我们如何查看线程的资源占用情况呢。</p>
<p>对于 top，我们可以在参数后加上 <code>-H</code>，即</p>
<p>  <code>top -Hp &lt;pid&gt;</code></p>
<p>同样，对于 ps 指令，同样可以加上 <code>H</code> 参数</p>
<p>  <code>ps H -eo rss,pmem,pcpu,vsize,args  | sort -k 1 -r -n</code></p>
<p>如果希望查看一个进程树的情况，我们在知道进程名称的情况下，可以使用如下指令查看</p>
<p>  <code>ps -ef f | grep &lt;process_name&gt;</code></p>
<p>但是有些情况下上述指令是不准的，因为线程并没包括所属进程的名称，那么我们就可以使用下面的指令</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -Lf &lt;pid&gt;</span><br><span class="line"></span><br><span class="line">-L: Show threads, possibly with LWP and NLWP columns.</span><br></pre></td></tr></table></figure>
<p>以上就是 Linux 使用时查看进程、线程信息的一些基本指令介绍了，更多的会在以后的使用过程中再进行补充。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/03/20180703-使用Hexo与GitHub搭建简易博客/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keefe Lin"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hackerose"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/07/03/20180703-使用Hexo与GitHub搭建简易博客/" class="post-title-link" itemprop="url">使用Hexo与GitHub搭建简易博客</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-03 15:06:19" itemprop="dateCreated datePublished" datetime="2018-07-03T15:06:19+08:00">2018-07-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-05-17 14:53:33" itemprop="dateModified" datetime="2019-05-17T14:53:33+08:00">2019-05-17</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>说了很久想自己写一个个人博客，但是无奈就是患有拖延症，现在才想到逐渐补上。那好，就直接从怎样搭建现在这个简易博客说起。</p>
</blockquote>
<p>能够快速地搭建起这一个博客，非常感谢的是前辈们给出的相关文档。更多的，是依赖于 Hexo 这个开源框架，以及 GitHub 这个为广大程序员所熟知的平台。下面先简单介绍下他们的作用（其实更多的是记录给自己看）</p>
<hr>
<h3 id="GitHub-Pages"><a href="#GitHub-Pages" class="headerlink" title="GitHub Pages"></a>GitHub Pages</h3><p><a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> 是 GitHub 所提供的免费博客托管平台，并且有 GitHub 免费提供的域名，例如 <a href="https://username.github.io/，" target="_blank" rel="noopener">https://username.github.io/，</a><br>很大程度上减少了维护一个个人博客的成本。其本质上来说，就是静态网站的托管服务器。</p>
<h3 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h3><p><a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> 是一个快速搭建博客的框架，依赖于 Node.js，拥有丰富多彩的<a href="https://hexo.io/themes/" target="_blank" rel="noopener">主题</a>，能够直接将撰写好的 MarkDown 文件编译成为静态文件，嵌入到网站整体当中。</p>
<p>同时，Hexo 还能方便的与 GitHub Pages 结合，使用其封装好的 <code>hexo-cli</code> 命令行工具，一键部署更新后的代码到各个平台。</p>
<hr>
<h3 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h3><blockquote>
<p>事先声明，以下内容针对 Mac 用户，如果你不是 Mac 用户，那么欢迎<a href="https://osx.cx/2016-clover-macos-sierra10-12-1-jiaocheng.html" target="_blank" rel="noopener">摇身一变</a>成为 Mac 用户。</p>
</blockquote>
<p>首先，先完成 GitHub Pages 的配置。根据官方文档，其实步骤很简单。</p>
<ul>
<li>在 GitHub 创建名为 <code>username.github.io</code> 的仓库，这里的 <code>username</code> 使用自己 GitHub 的用户名进行替换</li>
<li>然后在心里默念仓库地址 10 遍，等下要用到，<code>https://github.com/username/username.github.io</code></li>
</ul>
<p>关于 GitHub Pages 所需要做的，其实就是这么多。接下来，就是要使用 Hexo，创建博客网站，并提交到 <code>username.github.io</code> 这个仓库就可以了。</p>
<p>接下来，我们开始关键的步骤（这里假定我们已经是 GitHub 的熟手，早已完成了 SSH key 以及其他繁杂的配置）。</p>
<ul>
<li><p>安装 hexo</p>
<p>如果你已经安装了 <code>npm</code>，那么恭喜你，一行命令解千愁。</p>
<p><code>npm install -g hexo</code></p>
<p>如果还没有，而且你是苹果用户，希望你已经装了 <a href="https://brew.sh/" target="_blank" rel="noopener">Homebrew</a>，如果还是没有的话，就点进去看看，安装 5 分钟，排错 2 小时，然后就能用 <code>brew</code> 指令安装 <code>npm</code> 了。编译可能有点久，耐心等等。</p>
<p><code>brew install npm</code></p>
</li>
<li><p>创建 hexo 项目</p>
<p>执行下面指令，项目名称自由发挥，我比较低调，就叫了 blog。</p>
<p><code>hexo init blog</code></p>
<p>然后到项目目录下，安装依赖</p>
<p><code>npm install</code></p>
<p>这时候，其实你也同样可以为 hexo 项目的源码创建一个独立的 git 仓库（不是刚刚的 <code>username.github.io</code>），方便对 hexo 的源码进行管理，包括你引入、修改主题，以及你创建的 MarkDown 文档。</p>
</li>
<li><p>配置 hexo 项目</p>
<p>初始化完成后，会在项目目录下发现名为 <code>_config.yml</code> 的文件，用你喜欢的任何编辑器打开它，修改其中的内容。</p>
<p>找到下面这一段配置，然后回忆一下刚刚默念过 10 遍的 GitHub Pages 的项目地址，大胆的填进去。当然，你也可以定制化分支，通常情况下没这个必要。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/deployment.html</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: https://github.com/username/username.github.io</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>
<p>这段配置就是告诉 hexo，它到时候编译出来的静态文件应该推送到哪里。最关键的配置其实就是这里，这里记得配置好 git 所用的 SSH key，不然是不能自动推送上去的。</p>
<p>至于主题，也是在配置文件中指定。例如我使用的就是 <a href="https://github.com/yanm1ng/hexo-theme-vexo" target="_blank" rel="noopener">vexo</a>，在主题自己的官网，能根据文档快速的将其引入到你自己的 hexo 项目中。</p>
</li>
</ul>
<hr>
<h3 id="大功告成"><a href="#大功告成" class="headerlink" title="大功告成"></a>大功告成</h3><p>好了，该装的已经装了，该配的已经配了。那我们就开始撰写自己的博客，并推送到服务器上吧。</p>
<ul>
<li><p>创建博文</p>
<p>使用指令 <code>hexo new article_name</code>，创建一篇博文，你会在 <code>source/_posts</code> 目录下，找到对应的 MarkDown 文件。</p>
<p>打开该文件，默认会生成以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: article_name</span><br><span class="line">date: 2018-07-03 15:06:19</span><br><span class="line">tags:</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p><code>tags</code> 中你可以随意的加入自己的分类标签。</p>
</li>
<li><p>生成和部署</p>
<p>写完博文之后，运行下面的快捷命令，hexo 框架就会生成静态文件，并且部署到你指定的 GitHub Pages 仓库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo d -g # generate and deploy</span><br></pre></td></tr></table></figure>
</li>
<li><p>静静等待</p>
<p>现在你就可以访问 <code>https://username.github.io/</code> 查看自己的博客网站了。根据实测，将静态文件推送到仓库，到真正显示更新后的内容，大约需要半分钟到一分钟，所以，喝口茶、检查下错别字，确认下自己提交的内容准确无误吧。</p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Keefe Lin</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Keefe Lin</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
